# Published 노트 접근 기능

## 구현 목표

- OptionalAuthGuard를 이용해서 **로그인 하지 않은 유저도 published 파일에 접근 가능**
- Published 파일은 공개 파일이므로 누구나 볼 수 있어야 함

## 설계 사항

- **URL 패턴**: `/:libraryName/file-tree/published?userId=소유자ID`
- **userId를 query로 받는 이유**:
  - libraryName만으로는 소유자를 구별할 수 없음 (여러 사용자가 같은 이름의 라이브러리를 가질 수 있음)
  - GCS 경로 구성을 위해 필요: `user-libraries/{userId}/{libraryName}/published/`
- **OptionalAuthGuard 동작**:
  - 로그인 안한 유저: published 파일 접근 허용
  - 로그인한 유저: published 파일 + 추가 권한 정보 제공

---

# Private 노트 접근 기능

## 구현 목표

- OptionalAuthGuard를 이용해서 **로그인한 유저만 자신의 private 노트에 접근 가능**
- 본인 소유의 private 파일만 조회할 수 있어야 함

## 설계 사항

- **URL 패턴**: `/:libraryName/file-tree/private`
- **userId 처리**:
  - query 파라미터 없음 (보안상 이유)
  - JWT 토큰에서 추출한 `req.user.id` 사용
  - 본인의 libraryName에 해당하는 private 파일만 반환
- **OptionalAuthGuard 동작**:
  - 로그인 안한 유저: 접근 거부 (ForbiddenException)
  - 로그인한 유저: 본인의 private 파일만 접근 허용

## 보안 고려사항

- Private 파일은 반드시 인증된 사용자만 접근
- 다른 사용자의 private 파일에는 접근 불가
- JWT 토큰 검증을 통한 사용자 신원 확인

# getFileTree

지금 published, private를 검사하고 root library 파일, 폴더만 가져온다. 루트폴더 안에 하위폴더, 파일은 가져오지 않고 루트만 가져옴

---

# getFolderContents

## 구현 목표

- **하위 폴더의 세부 내용 조회**: `getFileTree`로 루트를 본 후, 특정 폴더를 클릭했을 때 그 폴더 안의 파일과 하위 폴더들을 동적으로 로딩
- **Published와 Private 모두 지원**: 상태별로 적절한 접근 권한 적용

## 설계 사항

- **URL 패턴**: `/:libraryName/file-tree/private/folder?path=폴더경로`
- **매개변수**:
  - `userId`: 사용자 ID (private는 필수, published는 경로에서 추출)
  - `libraryName`: 라이브러리명
  - `folderPath`: 조회할 폴더의 전체 경로 또는 상대 경로
- **StorageService 위임**: 실제 로직은 `storageService.getFolderContents()`에서 처리

## 동작 흐름

1. **권한 검증**: Private 파일의 경우 사용자 인증 확인
2. **경로 정규화**: 전체 경로가 오면 상대 경로로 변환
3. **GCS 조회**: 해당 폴더의 직접적인 파일과 1차 하위 폴더만 조회
4. **결과 반환**: `ResponseFileTree` 형태로 폴더 구조 + 파일 목록 반환

## 사용 예시

```typescript
// Private 폴더 내용 조회
GET /:libraryName/file-tree/private/folder?path=docs/api
// → user-libraries/{userId}/{libraryName}/private/docs/api/ 내용 조회

// Published 폴더 내용 조회
GET /:libraryName/file-tree/published/folder?path=user-libraries/123/myLib/published/tutorials
// → 해당 경로의 내용 조회 (로그인 불필요)
```

## 핵심 특징

- **1레벨만 조회**: delimiter 사용으로 성능 최적화
- **동적 로딩**: 필요한 폴더만 요청시 조회
- **권한 분리**: Published는 누구나, Private는 본인만 접근

---

# 통합 컨트롤러 패턴 (추가 구현)

## 구현 목표

- **단일 엔드포인트**: `status` 파라미터로 published/private 구분
- **코드 중복 제거**: 하나의 컨트롤러 메서드로 통합 처리
- **명시적 Status 전달**: URL 경로가 아닌 query parameter로 상태 구분

## 설계 사항

- **URL 패턴**: `/:libraryName/file-tree?status=published|private`
- **매개변수**:
  - `status`: 'published' | 'private' (query parameter)
  - `userId`: JWT에서 추출 또는 query로 전달
  - `libraryName`: URL path parameter
- **OptionalAuthGuard**: status에 따른 권한 검증

## 컨트롤러 구현

```typescript
@Get(':libraryName/file-tree')
@UseGuards(OptionalAuthGuard)
async getFileTree(
  @Request() req: { user: User },
  @Param('libraryName') libraryName: string,
  @Query('status') status: 'published' | 'private',
): Promise<ResponseFileTree> {
  const userId = req.user.id;

  if (status === 'published') {
    return await this.libraryService.getPublishedFileTree(userId, libraryName);
  } else {
    return await this.libraryService.getPrivateFileTree(userId, libraryName);
  }
}
```

## 서비스 통합 메서드

```typescript
async getFileTree(
  userId: string,
  libraryName: string,
  status: 'published' | 'private',
): Promise<ResponseFileTree> {
  return await this.storageService.getFileTree(userId, libraryName, status);
}
```

## 사용 예시

```typescript
// Published 파일 조회
GET /myLib/file-tree?status=published

// Private 파일 조회
GET /myLib/file-tree?status=private
```

## 장점

- **일관성**: 모든 파일 트리 조회가 같은 패턴
- **확장성**: 새로운 status 추가 시 로직만 수정
- **명확성**: status가 컨트롤러에서 명시적으로 처리됨

## 기존 개별 엔드포인트와 병행

- 기존 `/published`, `/private` 엔드포인트 유지
- 새로운 통합 엔드포인트 추가 제공
- 클라이언트가 선택적으로 사용 가능
