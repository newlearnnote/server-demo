// ===== GENERATOR & DATASOURCE =====

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== ACCOUNT MODELS =====

// JWT 토큰 블랙리스트 테이블 (JTI 기반)
model TokenBlacklist {
  jti       String   @id @db.VarChar(255) // JWT ID (Primary Key)
  expiresAt DateTime @db.Timestamp(6)     // 토큰 만료 시간
  createdAt DateTime @default(now())     // 블랙리스트 등록 시간

  @@map("token_blacklist")
}

enum notice_type_enum {
  follow          // 팔로우 알림
  like            // 좋아요 알림
  system          // 시스템 알림
}

model Notice {
  // Primary Key
  id          String  @id @default(ulid()) @db.VarChar(255)
  
  // Notice Information
  type              notice_type_enum  
  title             String            @db.VarChar(255)
  content           String            @db.Text
  isRead            Boolean           @default(false) @db.Boolean
  relatedEntityId   BigInt?           @db.BigInt
  relatedEntityName String?           @db.VarChar(255) 
  
  // 관리용 필드
  version     Int         @default(1) @db.Integer
  createdAt   DateTime    @default(now()) @db.Timestamp(6)
  updatedAt   DateTime    @updatedAt @db.Timestamp(6)
  deletedAt   DateTime?   @db.Timestamp(6)
  readAt      DateTime?   @db.Timestamp(6)
  
  // 관계 필드
  userId    String @db.VarChar(255)  
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notice")
}

enum user_role_enum {
  user
  admin
  super_admin
}

enum user_provider_enum {
  local
  google
}

enum user_language_enum {
  ko
  en
}



model User {
  // Primary Key
  id  String  @id @default(ulid()) @db.VarChar(255)

  // User Information
  email     String    @db.VarChar(255)
  password  String?   @db.VarChar(255)
  firstName String    @db.VarChar(255)
  lastName  String    @db.VarChar(255)
  oauthId   String?   @db.VarChar(255)

  // Profile Information
  nickname  String    @db.VarChar(100)
  avatarUrl String    @db.VarChar(500)
  
  // User Settings
  role      user_role_enum      @default(user)
  provider  user_provider_enum  @default(local)
  language  user_language_enum? @default(en)
  
  // Timestamps (Common fields)
  version   Int         @default(1) @db.Integer
  createdAt DateTime    @default(now()) @db.Timestamp(6)
  updatedAt DateTime    @default(now()) @updatedAt @db.Timestamp(6)
  deletedAt DateTime?   @db.Timestamp(6)
  
  // Relations
  notices Notice[]
  subscriptions Subscription[]
  payments Payment[]
  notes Note[]
  libraries Library[]
  comments Comment[]
  noteBookmarks NoteBookmark[]

  @@unique([email])
  @@unique([nickname])
  @@unique([oauthId, provider])
  @@map("user")
}


model PendingUser {
  // Primary Key
  id               BigInt      @id @default(autoincrement()) @db.BigInt
  
  // User Information
  email            String   @unique @db.VarChar
  password         String   @db.VarChar
  firstName        String   @db.VarChar
  lastName         String   @db.VarChar
  
  // Verification
  verificationCode String   @db.VarChar
  codeExpiresAt    DateTime @db.Timestamp(6)

  // Timestamps
  createdAt        DateTime @default(now()) @db.Timestamp(6)

  @@map("pending_user")
}

// ===== PAYMENT MODELS =====

model Payment {
    id          String      @id @default(ulid()) @db.VarChar(255)

    // 결제 정보
    amount          Decimal     @db.Decimal(10, 2) // 결제 금액
    currency        String      @db.VarChar(5) // 통화 단위 (예: USD, EUR)
    method          String      @db.VarChar(50) // 결제 수단 (예: credit_card, paypal)
    status          String      @db.VarChar(50) // 결제 상태 (예: completed, pending, failed)
    transactionId   String      @unique @db.VarChar(100) // 외부 결제 시스템의 거래 ID

    // 관리용 필드
    createdAt   DateTime    @default(now()) @db.Timestamp(6)

    // 관계 필드
    userId          String          @db.VarChar(255)
    subscriptionId  String          @db.VarChar(255)
    user            User            @relation(fields: [userId], references: [id])
    subscription    Subscription    @relation(fields: [subscriptionId], references: [id])

    @@index([userId])
    @@map("payment")
}

model SubscriptionPlan {
    id              String      @id @default(ulid()) @db.VarChar(255)
    name            String      @unique @db.VarChar(255) // 가격 플랜 이름
    description     String?     @db.Text // 플랜 설명
    price           Decimal     @db.Decimal(10, 2) // 플랜 가격
    currency        String      @db.VarChar(5) // 통화 단위 (예: USD, EUR)
    storageLimit    String      @db.VarChar(20) // 저장 용량 제한 (예: "10GB", "100GB")
    aiFeatures      Json        @db.Json // AI 기능 (예: {"chat": true, "imageGeneration": false})

    // 관리용 필드
    version         Int         @default(1) @db.Integer
    createdAt       DateTime    @default(now()) @db.Timestamp(6)
    updatedAt       DateTime    @updatedAt @db.Timestamp(6)
    deletedAt       DateTime?   @db.Timestamp(6)

    // 관계 필드
    subscriptions   Subscription[]

    @@map("subscription_plan")
}

model Subscription {
    id                  String      @id @default(ulid()) @db.VarChar(255)

    // 구독 정보
    status              String      @db.VarChar(50) // 예: active, canceled, past_due
    startDate           DateTime    @db.Timestamp(6)
    endDate             DateTime?   @db.Timestamp(6)

    // 관리형 필드
    version     Int         @default(1) @db.Integer
    createdAt   DateTime    @default(now()) @db.Timestamp(6)
    updatedAt   DateTime    @updatedAt @db.Timestamp(6)
    deletedAt   DateTime?   @db.Timestamp(6)

    // 관계 필드
    userId  String              @db.VarChar(255)
    planId  String              @db.VarChar(255)
    user    User                @relation(fields: [userId], references: [id])
    plan    SubscriptionPlan    @relation(fields: [planId], references: [id])
    payments Payment[]

    @@index([userId])
    @@index([planId])
    @@map("subscription")
}

// ===== SERVICE MODELS =====

model Comment {    // PK
    id        String   @id @default(ulid()) @db.VarChar(255)
    content   String   @db.Text // 댓글 내용
    
    // 관리용 필드  
    createdAt DateTime @default(now()) @db.Timestamp(6)

    // 관계 필드
    noteId    String   @db.VarChar(255)
    note      Note     @relation(fields: [noteId], references: [id])
    userId    String   @db.VarChar(255)
    user      User     @relation(fields: [userId], references: [id])

    // 대댓글 기능
    parentCommentId String?   @db.VarChar(255)
    parentComment   Comment?  @relation("CommentToReplies", fields: [parentCommentId], references: [id])
    replies         Comment[] @relation("CommentToReplies")

    @@map("comment")
}

 

model Library {
    id          String  @id @default(ulid()) @db.VarChar(255)
    name        String  @db.VarChar(255)
    storageUsed BigInt  @default(0) @db.BigInt

    // 관리용 필드
    version     Int         @default(1) @db.Integer
    linkedAt    DateTime    @default(now()) @db.Timestamp(6)
    createdAt   DateTime    @default(now()) @db.Timestamp(6)
    updatedAt   DateTime    @updatedAt @db.Timestamp(6)
    deletedAt   DateTime?   @db.Timestamp(6)

    // 관계 필드
    userId  String @db.VarChar(255)
    user    User @relation(fields: [userId], references: [id])
    notes   Note[]

    @@map("library")
}

model NoteBookmark {
    // PK
    id        String   @id @default(ulid()) @db.VarChar(255)
    
    // 관리용 필드  
    createdAt DateTime @default(now()) @db.Timestamp(6)
    deletedAt DateTime? @db.Timestamp(6)
    updatedAt DateTime @updatedAt @db.Timestamp(6)

    // 관계 필드
    noteId    String   @db.VarChar(255)
    note      Note     @relation(fields: [noteId], references: [id])
    userId    String   @db.VarChar(255)
    user      User     @relation(fields: [userId], references: [id])

    @@unique([noteId, userId])
    @@map("note_bookmark")
}

enum noteNetworkType {
  linked
  embed
}

model NoteNetwork {
    id       String             @id @default(ulid()) @db.VarChar(255)
    type     noteNetworkType    @default(linked)

    // 관리용 필드
    version   Int               @default(1) @db.Integer
    createdAt DateTime          @default(now()) @db.Timestamp(6)
    updatedAt DateTime          @default(now()) @updatedAt @db.Timestamp(6)
    deletedAt DateTime?         @db.Timestamp(6)

    // 관계 필드
    linkingNoteId     String           @db.VarChar(255)
    linkedNoteId      String           @db.VarChar(255)
    linkingNote       Note             @relation("linkingNote", fields: [linkingNoteId], references: [id])
    linkedNote        Note             @relation("linkedNote", fields: [linkedNoteId], references: [id])

    @@map("note_network")
}

model NoteTag {
    // PK
    id        String    @id @default(ulid()) @db.VarChar(255)

    // 관리용 필드
    createdAt DateTime  @default(now()) @db.Timestamp(6)
    updatedAt DateTime  @updatedAt @db.Timestamp(6)
    deletedAt DateTime? @db.Timestamp(6)

    // 관계 필드
    noteId String @db.VarChar(255)
    note   Note   @relation(fields: [noteId], references: [id])
    tagId  String @db.VarChar(255)
    tag    Tag    @relation(fields: [tagId], references: [id])

    @@map("note_tag")
}

model Note {
    id          String  @id @default(ulid()) @db.VarChar(255)
    title       String  @db.VarChar(255) // 노트 제목
    filePath    String @db.Text // 라이브러리에 저장된 파일 경로 user-library/{userId}/{libraryName}/published/file.md

    // 통계 필드
    bookmarkCount Int @default(0) @db.Integer // 북마크 수
    commentCount  Int @default(0) @db.Integer // 댓글 수

    // 관리용 필드
    version     Int         @default(1) @db.Integer
    createdAt   DateTime    @default(now()) @db.Timestamp(6)
    updatedAt   DateTime    @updatedAt @db.Timestamp(6)
    deletedAt   DateTime?   @db.Timestamp(6)

    // 관계 필드
    userId              String @db.VarChar(255)
    user                User @relation(fields: [userId], references: [id])
    libraryId           String @db.VarChar(255)
    library             Library @relation(fields: [libraryId], references: [id])
    noteTags            NoteTag[]
    noteBookmarks       NoteBookmark[]
    comments            Comment[]
    linkingNoteNetworks NoteNetwork[] @relation("linkingNote")
    linkedNoteNetworks  NoteNetwork[] @relation("linkedNote")

    @@map("note")
}

model Tag {
    id       String      @id @default(ulid()) @db.VarChar(255)
    name     String      @unique @db.VarChar(100) // 태그 이름

    // 관리용 필드
    createdAt DateTime    @default(now()) @db.Timestamp(6)
    noteTags NoteTag[]

    @@map("tag")
}

